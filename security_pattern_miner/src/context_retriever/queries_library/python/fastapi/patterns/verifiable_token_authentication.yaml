pattern:
  name: "Verifiable Token-Based Authentication (JWT)"
  id: "01_01_003"
  description: "A subject is identified based on a token that contains sufficient information to determine the correct principal, verified through digital signature or MAC"
  
dependencies:
  - fastapi
  - python-jose[cryptography]
  - PyJWT
  - cryptography
  - redis  # optional, for token revocation

roles:
  enforcer:
    description: "Ensures the requested action is only performed if the Subject is successfully authenticated"
    queries:
      - query: "HTTPBearer OAuth2PasswordBearer"
        description: "Bearer token enforcement"
        priority: high
      
      - query: "HTTPAuthorizationCredentials Depends"
        description: "HTTP authorization credentials dependency"
        priority: high
      
      - query: "security = HTTPBearer()"
        description: "HTTPBearer security scheme initialization"
        priority: high
      
      - query: "credentials: HTTPAuthorizationCredentials = Depends(security)"
        description: "Bearer token dependency injection"
        priority: high

  verifier:
    description: "Manages the verification of whether a token is valid"
    queries:
      - query: "jwt.decode SECRET_KEY algorithms"
        description: "JWT token verification"
        priority: high
      
      - query: "def verify_token jwt.decode"
        description: "Token verification functions"
        priority: high
      
      - query: "jwt.decode(token, SECRET_KEY, algorithms"
        description: "Direct JWT decode calls"
        priority: high
      
      - query: "payload = jwt.decode JWTError"
        description: "JWT decode with error handling"
        priority: high
      
      - query: "credentials.credentials jwt.decode"
        description: "Extracting and verifying JWT from credentials"
        priority: medium

  cryptographer_mac:
    description: "Provides cryptographic primitives for MAC-based tokens (HMAC)"
    queries:
      - query: "jwt.encode HS256 SECRET_KEY"
        description: "JWT encoding with HMAC"
        priority: high
      
      - query: "from jose import jwt"
        description: "Python-jose JWT import"
        priority: high
      
      - query: "algorithm = \"HS256\" jwt.encode"
        description: "HMAC algorithm configuration"
        priority: high
      
      - query: "jwt.encode jwt.decode HS256"
        description: "Complete HMAC JWT operations"
        priority: medium

  cryptographer_signature:
    description: "Provides cryptographic primitives for digitally signed tokens (RSA)"
    queries:
      - query: "jwt.encode RS256 private_key"
        description: "JWT encoding with RSA signature"
        priority: high
      
      - query: "jwt.decode public_key RS256"
        description: "JWT verification with public key"
        priority: high
      
      - query: "algorithm = \"RS256\" jwt"
        description: "RSA signature algorithm configuration"
        priority: high
      
      - query: "RS256 RS384 RS512 jwt"
        description: "RSA algorithm variants"
        priority: medium

  key_manager_hmac:
    description: "Manages cryptographic keys for HMAC tokens"
    queries:
      - query: "SECRET_KEY = os.getenv"
        description: "Secret key from environment"
        priority: high
      
      - query: "SECRET_KEY ALGORITHM = \"HS256\""
        description: "HMAC key and algorithm configuration"
        priority: high
      
      - query: "load_dotenv SECRET_KEY"
        description: "Loading secret keys from environment"
        priority: medium

  key_manager_rsa:
    description: "Manages cryptographic keys for RSA signed tokens"
    queries:
      - query: "rsa.generate_private_key public_exponent"
        description: "RSA key generation"
        priority: high
      
      - query: "from cryptography.hazmat.primitives.asymmetric import rsa"
        description: "RSA key management imports"
        priority: high
      
      - query: "private_key.public_key() serialization"
        description: "Public key extraction and serialization"
        priority: high
      
      - query: "serialization.PrivateFormat.PKCS8"
        description: "Private key serialization"
        priority: medium
      
      - query: "serialization.PublicFormat.SubjectPublicKeyInfo"
        description: "Public key serialization"
        priority: medium

  token_generator:
    description: "Manages the generation of new tokens"
    queries:
      - query: "def create_access_token jwt.encode"
        description: "Access token creation functions"
        priority: high
      
      - query: "jwt.encode exp sub"
        description: "JWT encoding with expiration and subject"
        priority: high
      
      - query: "create_access_token data: dict expires_delta"
        description: "Token creation with expiration parameter"
        priority: high
      
      - query: "timedelta(minutes jwt.encode"
        description: "Token expiration time calculation"
        priority: medium
      
      - query: "datetime.utcnow() + expires_delta"
        description: "Expiration timestamp calculation"
        priority: low

  registrar:
    description: "Provides the Subject a token after successful authentication"
    queries:
      - query: "@app.post /token create_access_token"
        description: "Token issuance endpoints"
        priority: high
      
      - query: "return access_token token_type bearer"
        description: "Token response formatting"
        priority: high
      
      - query: "@app.post /login jwt.encode"
        description: "Login endpoint with JWT generation"
        priority: high
      
      - query: "authenticate_user create_access_token"
        description: "Authentication followed by token creation"
        priority: medium

  token_blacklist:
    description: "Tracks revoked but not yet expired tokens (optional feature)"
    queries:
      - query: "redis.sadd revoked_tokens jwt"
        description: "Token revocation with Redis"
        priority: medium
      
      - query: "blacklist.revoke token"
        description: "Token blacklist management"
        priority: medium
      
      - query: "class TokenBlacklist revoked_tokens"
        description: "Token blacklist class"
        priority: medium
      
      - query: "is_revoked token HTTPException"
        description: "Revocation checking"
        priority: low

complete_implementation:
  description: "Queries to find files with complete JWT authentication implementation"
  queries:
    - query: "HTTPBearer jwt.encode jwt.decode SECRET_KEY lang:python"
      description: "Complete JWT authentication pattern"
      priority: critical
      min_matches: 4
    
    - query: "create_access_token jwt.encode exp sub lang:python -file:test"
      description: "Token generation with proper claims"
      priority: high
      min_matches: 3
    
    - query: "@app.post /token authenticate_user jwt.encode lang:python"
      description: "Token endpoint with authentication"
      priority: high
      min_matches: 3

endpoints:
  token_issuance:
    queries:
      - "@app.post /token"
      - "async def login_for_access_token"
      - "return {\"access_token\": access_token, \"token_type\": \"bearer\"}"
  
  token_refresh:
    queries:
      - "@app.post /refresh /token/refresh"
      - "def refresh_token verify_token"
  
  protected_endpoint:
    queries:
      - "async def read_users_me token: str = Depends"
      - "current_user = Depends(get_current_user)"

token_features:
  expiration:
    queries:
      - "exp datetime.utcnow"
      - "expires_delta timedelta"
      - "ACCESS_TOKEN_EXPIRE_MINUTES"
  
  claims:
    queries:
      - "sub username"
      - "payload.get(\"sub\")"
      - "to_encode.update exp iat"
  
  algorithms:
    hmac:
      queries:
        - "HS256"
        - "HS384"
        - "HS512"
    
    rsa:
      queries:
        - "RS256"
        - "RS384"
        - "RS512"

anti_patterns:
  description: "Security anti-patterns to detect"
  
  weak_algorithm:
    query: "algorithm = \"none\" jwt.encode"
    severity: critical
  
  missing_expiration:
    query: "jwt.encode -exp -expires"
    severity: high
  
  hardcoded_secret:
    query: "SECRET_KEY = \"my-secret-key\""
    severity: critical
  
  weak_secret:
    query: "SECRET_KEY = \"secret\" \"test\""
    severity: critical
  
  no_algorithm_verification:
    query: "jwt.decode -algorithms verify_signature=False"
    severity: critical

filters:
  language: python
  file_extension: "\\.py$"
  exclude_tests: true
  exclude_forks: true
  exclude_archived: true

search_strategy:
  steps:
    - name: "Find Enforcer"
      queries: ["HTTPBearer", "OAuth2PasswordBearer"]
      
    - name: "Find Token Generator"
      queries: ["create_access_token", "jwt.encode"]
      
    - name: "Find Verifier"
      queries: ["jwt.decode", "verify_token"]
      
    - name: "Find Key Management"
      queries: ["SECRET_KEY", "rsa.generate_private_key"]
      
    - name: "Verify Complete Implementation"
      queries: ["HTTPBearer jwt.encode jwt.decode"]

library_alternatives:
  jwt_libraries:
    - name: python-jose
      queries:
        - "from jose import jwt"
        - "from jose import JWTError"
    
    - name: PyJWT
      queries:
        - "import jwt"
        - "import jwt as PyJWT"
        - "from jwt import encode, decode"
