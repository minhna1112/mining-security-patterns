pattern:
  name: "Password-Based Authentication"
  id: "01_01_002"
  description: "A subject proves they own a claimed identity by providing a correct identifier and the corresponding password"
  
dependencies:
  - fastapi
  - passlib
  - cryptography

repo_metadata_file:
 - python_Pypi_mutual_dependents_fastapi_passlib.jsonl

roles:
  enforcer:
    description: "Ensures the requested action is only performed if the Subject is successfully authenticated"
    queries:
      - query: "Depends OAuth2PasswordRequestForm OAuth2PasswordRequestFormRestrict"
        description: "Files containing both OAuth2 password authentication classes"
        priority: high

      - query: "Depends HTTPBasic HTTPBasicCredentials"
        description: "Files implementing HTTP Basic authentication"
        priority: medium

  verification_manager:
    description: "Responsible to collect inputs necessary to verify a Subject's password"
    queries:
      - query: "CryptContext pwd_context verify"
        description: "Files with password verification context"
        priority: high
      
      - query: "def verify_password lang:python"
        description: "Python functions that verify passwords"
        priority: high
      
      - query: "authenticate_user username password"
        description: "User authentication functions"
        priority: high

  comparator:
    description: "Compares the hash value of the received password against stored hash"
    queries:
      - query: "pwd_context.verify bcrypt.checkpw"
        description: "Files containing password comparison functions"
        priority: high
      
      - query: "pwd_context.verify(plain_password, hashed_password)"
        description: "Direct password verification calls"
        priority: high
      
      - query: "bcrypt.checkpw password.encode"
        description: "Bcrypt password checking"
        priority: medium

  hasher:
    description: "Calculates the hash value for a given input"
    queries:
      - query: "pwd_context.hash bcrypt.hashpw"
        description: "Files with password hashing implementations"
        priority: high
      
      - query: "CryptContext schemes bcrypt"
        description: "Files configuring bcrypt hashing"
        priority: high
      
      - query: "pwd_context.hash(password)"
        description: "Direct password hashing calls"
        priority: high
      
      - query: "bcrypt.gensalt bcrypt.hashpw"
        description: "Bcrypt salt generation and hashing"
        priority: medium

  password_store:
    description: "Keeps track of hash values corresponding to each registered identity"
    queries:
      - query: "hashed_password User.query"
        description: "Files with user password storage queries"
        priority: high
      
      - query: "class User password sqlalchemy"
        description: "SQLAlchemy User models with password fields"
        priority: high
      
      - query: "Column String hashed_password"
        description: "Database column for hashed passwords"
        priority: high
      
      - query: "db.query(User).filter username"
        description: "User lookup queries"
        priority: medium

  pepper_store:
    description: "Keeps track of the pepper value(s) used by the system"
    queries:
      - query: "Fernet pepper_key encrypt"
        description: "Files implementing pepper encryption"
        priority: medium
      
      - query: "pepper cipher.encrypt"
        description: "Pepper encryption operations"
        priority: medium

  encrypter:
    description: "Encrypts a given data element using a given cryptographic key"
    queries:
      - query: "from cryptography.fernet import Fernet"
        description: "Files importing Fernet encryption"
        priority: medium
      
      - query: "Fernet.generate_key cipher.encrypt"
        description: "Fernet key generation and encryption"
        priority: medium

  registrar:
    description: "Handles the Subject's registration"
    queries:
      - query: "@app.post /register pwd_context.hash"
        description: "Registration endpoints with password hashing"
        priority: high
      
      - query: "def register_user db.add"
        description: "User registration functions"
        priority: high
      
      - query: "@app.post /signup create_user"
        description: "Signup endpoints"
        priority: medium
      
      - query: "new_user = User db.commit"
        description: "User creation and database commit"
        priority: medium

  password_policy:
    description: "Contains the rules any password should satisfy"
    queries:
      - query: "@validator password len"
        description: "Pydantic password validators"
        priority: high
      
      - query: "class PasswordPolicy validate"
        description: "Password policy validation classes"
        priority: medium
      
      - query: "password len min_length max_length"
        description: "Password length validation"
        priority: medium
      
      - query: "raise ValueError password must"
        description: "Password validation errors"
        priority: low

  srng:
    description: "Cryptographically secure random number generator"
    queries:
      - query: "secrets.token_urlsafe secrets.token_bytes"
        description: "Secure random number generation"
        priority: high
      
      - query: "import secrets token"
        description: "Secrets module usage for tokens"
        priority: medium

complete_implementation:
  description: "Queries to find files with complete password authentication implementation"
  queries:
    - query: "OAuth2PasswordBearer CryptContext pwd_context.hash pwd_context.verify lang:python"
      description: "Complete password authentication pattern"
      priority: critical
      min_matches: 4
    
    - query: "@app.post /login authenticate_user pwd_context lang:python -file:test"
      description: "Login endpoint with authentication"
      priority: high
      min_matches: 3

endpoints:
  login:
    queries:
      - "@app.post /login /signin /auth"
      - "async def login form_data: OAuth2PasswordRequestForm"
  
  register:
    queries:
      - "@app.post /register /signup"
      - "def register_user username password"
  
  password_reset:
    queries:
      - "@app.post /reset-password /forgot-password"
      - "reset_token send_email"
